# 安全存储说明

## API Key 安全存储方案

本扩展基于 Cline 的设计，实现了企业级的 API Key 安全存储方案，确保您的 DeepSeek API Key 得到最高级别的保护。

## 安全特性

### 1. 系统级加密存储
- **Windows**: 使用 Windows Credential Manager 进行加密存储
- **macOS**: 使用 macOS Keychain 进行加密存储  
- **Linux**: 使用 Secret Service API 进行加密存储

### 2. 零明文存储
- API Key 永远不会以明文形式存储在配置文件中
- 所有敏感信息都通过 VSCode Secrets API 进行加密处理
- 自动加密/解密，无需手动密钥管理

### 3. 临时配置文件支持
- 测试环境下支持内存存储，进程结束后自动清除
- 通过 `TEMP_PROFILE=true` 环境变量启用
- 避免在测试或临时环境中留下敏感信息

### 4. 跨窗口同步
- 支持多个 VSCode 窗口间的 API Key 同步
- 一个窗口更新 API Key，其他窗口自动感知变更
- 确保所有实例的认证状态保持一致

## 使用方法

### 设置 API Key
1. 打开扩展的 WebView 界面
2. 点击"配置 API Key"
3. 输入您的 DeepSeek API Key
4. 系统会自动验证并安全存储

### 查看配置状态
- 扩展会显示 API Key 的掩码版本（如：sk-****-****-1234）
- 显示当前使用的模型和温度设置
- 指示 API Key 是否已正确配置

### 更新配置
- 可以随时更新 API Key、模型或温度设置
- 所有更改都会立即生效并安全存储
- 支持批量更新以优化性能

### 重置配置
- 可以完全清除所有存储的配置信息
- 包括 API Key、模型设置和认证信息
- 确保彻底删除，不留任何残留

## 技术实现

### 存储架构
```
VSCode Secrets API
├── Windows Credential Manager
├── macOS Keychain  
└── Linux Secret Service
```

### 性能优化
- **批量操作**: 使用 `Promise.all()` 并行处理多个存储操作
- **减少 I/O**: 最小化与系统密钥存储的交互次数
- **内存缓存**: 临时配置使用高效的 Map 存储

### 错误处理
- 优雅处理密钥缺失或无效情况
- 详细的错误日志和用户友好的错误提示
- 自动重试机制和降级策略

## 开发者测试

### 测试命令（开发模式）
在开发模式下，扩展会注册以下测试命令：

1. **基本存储测试**
   ```
   命令: enhancePrompt.testStorage
   功能: 测试 API Key 的存储、读取、更新和删除
   ```

2. **跨平台兼容性测试**
   ```
   命令: enhancePrompt.testCrossPlatform  
   功能: 测试不同平台下的存储兼容性
   ```

### 运行测试
1. 在开发模式下启动扩展
2. 打开命令面板 (Ctrl+Shift+P / Cmd+Shift+P)
3. 运行测试命令
4. 查看输出通道了解测试结果

## 安全最佳实践

### 用户须知
1. **保护您的 API Key**: 不要在代码、文档或聊天中分享您的 API Key
2. **定期轮换**: 建议定期更换 API Key 以提高安全性
3. **监控使用**: 定期检查 API Key 的使用情况和账单
4. **安全环境**: 确保您的开发环境安全，避免恶意软件

### 开发者须知
1. **不要记录敏感信息**: 避免在日志中输出完整的 API Key
2. **使用掩码显示**: 在 UI 中始终显示掩码后的 API Key
3. **验证输入**: 在存储前验证 API Key 的格式和有效性
4. **错误处理**: 妥善处理存储失败的情况

## 故障排除

### 常见问题

**Q: API Key 存储失败**
A: 检查系统权限，确保 VSCode 有访问系统密钥存储的权限

**Q: 跨窗口同步不工作**  
A: 重启 VSCode 或检查是否有多个版本的扩展同时运行

**Q: 临时配置模式下数据丢失**
A: 这是正常行为，临时模式下数据不会持久化

**Q: Linux 下存储失败**
A: 确保安装了 Secret Service 支持（如 gnome-keyring）

### 获取帮助
如果遇到安全相关问题，请：
1. 查看 VSCode 输出通道的错误信息
2. 检查系统日志
3. 在项目仓库提交 Issue（不要包含敏感信息）

## 更新日志

### v0.0.1
- 实现基于 VSCode Secrets API 的安全存储
- 支持 Windows/Mac/Linux 跨平台
- 添加临时配置文件支持
- 实现跨窗口同步机制
- 添加批量操作优化
- 完整的测试套件
