<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none';
               img-src vscode-resource: vscode-webview-resource: https: data: blob:;
               style-src 'unsafe-inline' vscode-resource: vscode-webview-resource:;
               script-src 'nonce-{{NONCE}}' 'unsafe-eval' vscode-resource: vscode-webview-resource:;
               font-src vscode-resource: vscode-webview-resource:;
               connect-src vscode-resource: vscode-webview-resource: ws: wss:;"
    />
    <title>Enhance Prompt — Clarify</title>

    <!-- 预加载关键资源 -->
    <link rel="preload" href="{{STYLES_URI}}" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="preload" href="{{SPARKLES_URI}}" as="image" />

    <!-- 样式表 - 使用 onload 确保样式加载完成 -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{{STYLES_URI}}"
      onload="document.documentElement.classList.add('styles-loaded')"
    />

    <!-- 内联关键 CSS 防止 FOUC -->
    <style>
      /* 关键路径 CSS - 防止无样式内容闪烁 */
      html {
        background-color: var(--vscode-sideBar-background, #1e1e1e);
        color: var(--vscode-editor-foreground, #cccccc);
      }
      body {
        margin: 0;
        font-family: var(--vscode-font-family, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif);
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
      }

      .hydrated {
        opacity: 1 !important;
      }

      /* 开发模式样式 - 仅在开发模式下显示 */
      .dev-mode body::before {
        content: 'DEV MODE';
        position: fixed;
        top: 0;
        right: 0;
        background: #ff6b35;
        color: white;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        z-index: 9999;
        border-radius: 0 0 0 4px;
      }

      .dev-info {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: #00ff00;
        padding: 4px 8px;
        font-size: 10px;
        border-radius: 4px;
        font-family: monospace;
        z-index: 9998;
        display: none;
      }

      .dev-mode .dev-info {
        display: block;
      }

      /* 模型选择器样式 */
      #modelSelector {
        display: flex;
        align-items: center;
        margin-right: 10px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.2);
        transition: background-color 0.2s;
      }

      #modelSelector:hover {
        background-color: rgba(0, 0, 0, 0.3);
      }

      #currentModelDisplay {
        font-size: 12px;
        color: #ccc;
        white-space: nowrap;
      }



      /* 弹出窗口样式 - 参考 Cline 的设计 */
      .popup-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        background: var(--vscode-editor-background, var(--vscode-sideBar-background, #1e1e1e));
        border: 1px solid var(--vscode-editorGroup-border, #3c3c3c);
        border-radius: 8px;
        box-shadow:
          0 16px 48px rgba(0, 0, 0, 0.5),
          0 8px 24px rgba(0, 0, 0, 0.3),
          0 4px 12px rgba(0, 0, 0, 0.2);
        min-width: 320px;
        max-width: 480px;
        width: 90vw;
        max-height: 80vh;
        overflow: hidden;
        z-index: 10000;
        display: none;
        opacity: 0;
        transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
      }

      .popup-container.show {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
        pointer-events: auto;
      }

      /* 弹出窗口头部 */
      .popup-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--vscode-editorGroup-border, #3c3c3c);
        background: var(--vscode-editor-background, #1e1e1e);
      }

      .popup-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--vscode-editor-foreground, #cccccc);
        margin: 0;
      }

      .popup-close {
        background: none;
        border: none;
        color: var(--vscode-editor-foreground, #cccccc);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        transition: background-color 0.15s ease;
      }

      .popup-close:hover {
        background: var(--vscode-toolbar-hoverBackground, rgba(255, 255, 255, 0.1));
      }

      .popup-close:active {
        background: var(--vscode-toolbar-activeBackground, rgba(255, 255, 255, 0.15));
      }

      /* 弹出窗口内容区域 */
      .popup-content {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(80vh - 60px);
      }

      /* 弹出窗口内的配置字段样式调整 */
      .popup-container .config-field {
        margin-bottom: 20px;
      }

      .popup-container .config-field:last-child {
        margin-bottom: 0;
      }

      /* 弹出窗口内的模型信息样式调整 */
      .popup-container .model-info {
        margin: 16px 0 0 0;
        padding: 12px;
        background: var(--vscode-editorWidget-background, rgba(255, 255, 255, 0.05));
        border: 1px solid var(--vscode-editorWidget-border, #3c3c3c);
        border-radius: 6px;
      }

      /* 响应式设计 */
      @media (max-width: 480px) {
        .popup-container {
          min-width: 280px;
          width: 95vw;
          max-height: 90vh;
        }

        .popup-header {
          padding: 12px 16px;
        }

        .popup-content {
          padding: 16px;
          max-height: calc(90vh - 50px);
        }
      }

      /* 可调整大小的手柄 */
      .popup-resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 16px;
        height: 16px;
        cursor: se-resize;
        background: linear-gradient(
          -45deg,
          transparent 0%,
          transparent 40%,
          var(--vscode-editorGroup-border, #3c3c3c) 40%,
          var(--vscode-editorGroup-border, #3c3c3c) 45%,
          transparent 45%,
          transparent 55%,
          var(--vscode-editorGroup-border, #3c3c3c) 55%,
          var(--vscode-editorGroup-border, #3c3c3c) 60%,
          transparent 60%
        );
        opacity: 0.6;
        transition: opacity 0.15s ease;
      }

      .popup-resize-handle:hover {
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <!-- 开发信息显示 - 仅在开发模式下显示 -->
    <div class="dev-info" id="devInfo">
      Client: {{CLIENT_ID}}<br />
      Hot Reload: Active
    </div>

    <!-- API 配置区域 - 现在通过弹出窗口访问 -->
    <div class="api-config-panel" style="display: none;">
      <!-- API Provider 显示（不可选择） -->
      <div class="config-field">
        <label class="config-label">API Provider</label>
        <div class="provider-display">
          <span class="provider-name">DeepSeek</span>
        </div>
      </div>

      <!-- API Key 输入 -->
      <div class="config-field">
        <label class="config-label">DeepSeek API Key</label>
        <div class="api-key-container">
          <input type="password" id="apiKeyInput" class="api-key-input" placeholder="Enter API Key..." />
        </div>
        <p class="config-description">
          This key is stored locally and only used to make API requests from this extension.
        </p>
      </div>

      <!-- Model 选择 -->
      <div class="config-field">
        <label class="config-label">Model</label>
        <div class="dropdown-container">
          <select id="modelSelect" class="config-dropdown">
            <option value="deepseek-chat" selected>deepseek-chat</option>
            <option value="deepseek-reasoner">deepseek-reasoner</option>
          </select>
        </div>
      </div>

      <!-- 模型信息显示 -->
      <div class="model-info" id="modelInfo">
        <div class="info-item">
          <span class="info-label">输出长度：</span>
          <span class="info-value" id="maxOutputValue">默认 4K，最大 8K</span>
        </div>
        <div class="info-item">
          <span class="info-label">输入价格：</span>
          <span class="info-value" id="cacheWritePriceValue">2元/百万 tokens（标准）</span>
        </div>
        <div class="info-item">
          <span class="info-label">缓存命中：</span>
          <span class="info-value" id="cacheReadPriceValue">0.5元/百万 tokens（缓存命中）</span>
        </div>
        <div class="info-item">
          <span class="info-label">输出价格：</span>
          <span class="info-value" id="outputPriceValue">8元/百万 tokens（标准）</span>
        </div>
        <div class="info-item" style="font-size: 12px; color: #666; margin-top: 8px">
          <span class="info-label">优惠时段：</span>
          <span class="info-value">北京时间 00:30-08:30 享受 5 折优惠</span>
        </div>
      </div>
    </div>

    <!-- 输入框 -->
    <div class="input-box">
      <div class="input-box-content">
        <textarea id="input" placeholder="输入原始描述… ( Ctrl/Cmd + Enter 执行 )"></textarea>
      </div>
      <div class="toolbar">
        <a role="button" title="Select Model / API Provider" tabindex="0" id="modelSelector">
          <div id="currentModelDisplay">deepseek-chat</div>
        </a>
        <div class="toolbar-right">
          <button id="runBtn" class="btn">
            <img src="{{SPARKLES_URI}}" alt="sparkles" style="width: 14px; height: 14px" /> 增强
          </button>
          <button id="copyBtn" class="btn" disabled>复制</button>
          <button id="clearBtn" class="btn" disabled>清空</button>
        </div>
      </div>
    </div>

    <!-- 结果展示 -->
    <pre id="result" class="result" hidden></pre>



    <!-- API 配置弹出窗口 -->
    <div class="popup-container" id="configPopup">
        <!-- 弹出窗口头部 -->
        <div class="popup-header">
          <h3 class="popup-title">API Provider Settings</h3>
          <button class="popup-close" id="popupCloseBtn" title="Close">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
              <path d="M6 4.586L10.293.293a1 1 0 011.414 1.414L7.414 6l4.293 4.293a1 1 0 01-1.414 1.414L6 7.414l-4.293 4.293a1 1 0 01-1.414-1.414L4.586 6 .293 1.707A1 1 0 011.707.293L6 4.586z"/>
            </svg>
          </button>
        </div>

        <!-- 弹出窗口内容 -->
        <div class="popup-content">
          <!-- API Provider 显示（不可选择） -->
          <div class="config-field">
            <label class="config-label">API Provider</label>
            <div class="provider-display">
              <span class="provider-name">DeepSeek</span>
            </div>
          </div>

          <!-- API Key 输入 -->
          <div class="config-field">
            <label class="config-label">DeepSeek API Key</label>
            <div class="api-key-container">
              <input type="password" id="popupApiKeyInput" class="api-key-input" placeholder="Enter API Key..." />
            </div>
            <p class="config-description">
              This key is stored locally and only used to make API requests from this extension.
            </p>
          </div>

          <!-- Model 选择 -->
          <div class="config-field">
            <label class="config-label">Model</label>
            <div class="dropdown-container">
              <select id="popupModelSelect" class="config-dropdown">
                <option value="deepseek-chat" selected>deepseek-chat</option>
                <option value="deepseek-reasoner">deepseek-reasoner</option>
              </select>
            </div>
          </div>

          <!-- 模型信息显示 -->
          <div class="model-info" id="popupModelInfo">
            <div class="info-item">
              <span class="info-label">输出长度：</span>
              <span class="info-value" id="popupMaxOutputValue">默认 4K，最大 8K</span>
            </div>
            <div class="info-item">
              <span class="info-label">输入价格：</span>
              <span class="info-value" id="popupCacheWritePriceValue">2元/百万 tokens（标准）</span>
            </div>
            <div class="info-item">
              <span class="info-label">缓存命中：</span>
              <span class="info-value" id="popupCacheReadPriceValue">0.5元/百万 tokens（缓存命中）</span>
            </div>
            <div class="info-item">
              <span class="info-label">输出价格：</span>
              <span class="info-value" id="popupOutputPriceValue">8元/百万 tokens（标准）</span>
            </div>
            <div class="info-item" style="font-size: 12px; color: #666; margin-top: 8px">
              <span class="info-label">优惠时段：</span>
              <span class="info-value">北京时间 00:30-08:30 享受 5 折优惠</span>
            </div>
          </div>
        </div>

        <!-- 可调整大小的手柄 -->
        <div class="popup-resize-handle" id="popupResizeHandle"></div>
    </div>

    <!-- 配置注入脚本 -->
    <script nonce="{{NONCE}}">
      // 全局配置
      window.enhancePromptClientId = '{{CLIENT_ID}}'
      window.enhancePromptConfig = {} // Will be replaced with {{CONFIG}} during template processing

      // 状态水合标志
      window.enhancePromptHydrated = false

      // 开发模式检测和初始化
      window.isDevelopment = window.enhancePromptConfig?.isDevelopment || false

      // 如果是开发模式，添加相应的 CSS 类
      if (window.isDevelopment) {
        document.documentElement.classList.add('dev-mode')
        console.log('[DEV] Development mode activated')
      }
    </script>

    <!-- 开发模式热重载脚本 -->
    <script nonce="{{NONCE}}">
      // 开发模式热重载和调试工具
      if (window.isDevelopment) {
        let reloadCheckInterval
        let lastModified = Date.now()

        const checkForReload = () => {
          const now = Date.now()
          if (now - lastModified > 30000) {
            console.log('[DEV] Checking for updates...')
            lastModified = now
          }
        }

        // 启动热重载检查
        reloadCheckInterval = setInterval(checkForReload, 5000)

        // 清理函数
        window.addEventListener('beforeunload', () => {
          if (reloadCheckInterval) {
            clearInterval(reloadCheckInterval)
          }
        })

        // 开发工具
        window.devTools = {
          clearState: () => {
            const vscode = acquireVsCodeApi()
            vscode.setState(null)
            console.log('[DEV] State cleared')
          },
          logState: () => {
            const vscode = acquireVsCodeApi()
            console.log('[DEV] Current state:', vscode.getState())
          },
          logConfig: () => {
            console.log('[DEV] Current config:', window.enhancePromptConfig)
          },
        }

        console.log('[DEV] Development tools loaded. Use window.devTools for debugging.')
      }
    </script>

    <!-- 主应用脚本 -->
    <script nonce="{{NONCE}}">
      ;(() => {
        const vscode = acquireVsCodeApi()
        const $input = document.getElementById('input')
        const $run = document.getElementById('runBtn')
        const $copy = document.getElementById('copyBtn')
        const $clear = document.getElementById('clearBtn')
        const $result = document.getElementById('result')
        const $body = document.body
        const $devInfo = document.getElementById('devInfo')

        // 配置相关元素
        const $apiKeyInput = document.getElementById('apiKeyInput')
        const $modelSelect = document.getElementById('modelSelect')
        const $modelInfo = document.getElementById('modelInfo')
        const $currentModelDisplay = document.getElementById('currentModelDisplay')
        const $modelSelector = document.getElementById('modelSelector')

        // 弹出窗口相关元素
        const $configPopup = document.getElementById('configPopup')
        const $popupCloseBtn = document.getElementById('popupCloseBtn')
        const $popupResizeHandle = document.getElementById('popupResizeHandle')
        const $popupApiKeyInput = document.getElementById('popupApiKeyInput')
        const $popupModelSelect = document.getElementById('popupModelSelect')
        const $popupModelInfo = document.getElementById('popupModelInfo')
        const $popupMaxOutputValue = document.getElementById('popupMaxOutputValue')
        const $popupCacheWritePriceValue = document.getElementById('popupCacheWritePriceValue')
        const $popupCacheReadPriceValue = document.getElementById('popupCacheReadPriceValue')
        const $popupOutputPriceValue = document.getElementById('popupOutputPriceValue')

        let enhancedText = ''
        let isInitialized = false
        let currentConfig = null
        let selectedProvider = 'deepseek'
        let selectedModel = 'deepseek-chat'

        // ---------- 配置管理功能 ----------
        const updateCurrentModelDisplay = (model) => {
          // 更新工具栏中的模型显示
          if ($currentModelDisplay) {
            $currentModelDisplay.textContent = `${model}`
          }
        }

        // ---------- 弹出窗口管理功能 ----------
        const showConfigPopup = () => {
          // 同步当前配置到弹出窗口
          syncConfigToPopup()

          // 显示弹出窗口
          $configPopup.classList.add('show')

          // 添加键盘事件监听
          document.addEventListener('keydown', handlePopupKeydown)
        }

        const hideConfigPopup = () => {
          $configPopup.classList.remove('show')

          // 移除键盘事件监听
          document.removeEventListener('keydown', handlePopupKeydown)
        }

        const handlePopupKeydown = (e) => {
          if (e.key === 'Escape') {
            hideConfigPopup()
          }
        }

        // 弹出窗口可调整大小功能
        let isResizing = false
        let startX, startY, startWidth, startHeight

        const initResize = (e) => {
          isResizing = true
          startX = e.clientX
          startY = e.clientY

          const rect = $configPopup.getBoundingClientRect()
          startWidth = rect.width
          startHeight = rect.height

          document.addEventListener('mousemove', doResize)
          document.addEventListener('mouseup', stopResize)
          e.preventDefault()
        }

        const doResize = (e) => {
          if (!isResizing) return

          const width = startWidth + (e.clientX - startX)
          const height = startHeight + (e.clientY - startY)

          // 设置最小和最大尺寸
          const minWidth = 320
          const maxWidth = Math.min(window.innerWidth * 0.9, 800)
          const minHeight = 200
          const maxHeight = window.innerHeight * 0.9

          const newWidth = Math.max(minWidth, Math.min(maxWidth, width))
          const newHeight = Math.max(minHeight, Math.min(maxHeight, height))

          $configPopup.style.width = `${newWidth}px`
          $configPopup.style.height = `${newHeight}px`
        }

        const stopResize = () => {
          isResizing = false
          document.removeEventListener('mousemove', doResize)
          document.removeEventListener('mouseup', stopResize)
        }

        const syncConfigToPopup = () => {
          // 同步 API Key
          $popupApiKeyInput.value = $apiKeyInput.value
          $popupApiKeyInput.dataset.isMasked = $apiKeyInput.dataset.isMasked
          $popupApiKeyInput.dataset.originalMask = $apiKeyInput.dataset.originalMask

          // 同步模型选择
          $popupModelSelect.value = $modelSelect.value

          // 同步模型信息
          updatePopupModelInfo($modelSelect.value)
        }

        const syncConfigFromPopup = () => {
          // 同步 API Key
          $apiKeyInput.value = $popupApiKeyInput.value
          $apiKeyInput.dataset.isMasked = $popupApiKeyInput.dataset.isMasked
          if ($popupApiKeyInput.dataset.originalMask) {
            $apiKeyInput.dataset.originalMask = $popupApiKeyInput.dataset.originalMask
          }

          // 同步模型选择
          $modelSelect.value = $popupModelSelect.value
          selectedModel = $popupModelSelect.value

          // 更新主界面显示
          updateModelInfo(selectedModel)
          updateCurrentModelDisplay(selectedModel)
        }

        const updatePopupModelInfo = (model) => {
          // 根据选择的模型更新弹出窗口中的信息显示
          const modelData = {
            'deepseek-chat': {
              maxOutput: '默认 4K，最大 8K',
              cacheWritePrice: '2元/百万 tokens（标准）',
              cacheReadPrice: '0.5元/百万 tokens（缓存命中）',
              outputPrice: '8元/百万 tokens（标准）',
            },
            'deepseek-reasoner': {
              maxOutput: '默认 32K，最大 64K',
              cacheWritePrice: '4元/百万 tokens（标准）',
              cacheReadPrice: '1元/百万 tokens（缓存命中）',
              outputPrice: '16元/百万 tokens（标准）',
            },
            'deepseek-coder': {
              maxOutput: '默认 4K，最大 8K',
              cacheWritePrice: '2元/百万 tokens（标准）',
              cacheReadPrice: '0.5元/百万 tokens（缓存命中）',
              outputPrice: '8元/百万 tokens（标准）',
            },
          }

          const data = modelData[model]
          if (!data) {
            $popupModelInfo.style.display = 'none'
            return
          }

          $popupModelInfo.style.display = 'block'

          // 动态更新弹出窗口中的模型信息
          if ($popupMaxOutputValue) $popupMaxOutputValue.textContent = data.maxOutput
          if ($popupCacheWritePriceValue) $popupCacheWritePriceValue.textContent = data.cacheWritePrice
          if ($popupCacheReadPriceValue) $popupCacheReadPriceValue.textContent = data.cacheReadPrice
          if ($popupOutputPriceValue) $popupOutputPriceValue.textContent = data.outputPrice
        }

        const updateModelInfo = (model) => {
          // 根据选择的模型更新信息显示
          const modelData = {
            'deepseek-chat': {
              maxOutput: '默认 4K，最大 8K',
              cacheWritePrice: '2元/百万 tokens（标准）',
              cacheReadPrice: '0.5元/百万 tokens（缓存命中）',
              outputPrice: '8元/百万 tokens（标准）',
            },
            'deepseek-reasoner': {
              maxOutput: '默认 32K，最大 64K',
              cacheWritePrice: '4元/百万 tokens（标准）',
              cacheReadPrice: '1元/百万 tokens（缓存命中）',
              outputPrice: '16元/百万 tokens（标准）',
            },
            'deepseek-coder': {
              maxOutput: '默认 4K，最大 8K',
              cacheWritePrice: '2元/百万 tokens（标准）',
              cacheReadPrice: '0.5元/百万 tokens（缓存命中）',
              outputPrice: '8元/百万 tokens（标准）',
            },
          }

          const data = modelData[model]
          if (!data) {
            $modelInfo.style.display = 'none'
            return
          }

          $modelInfo.style.display = 'block'

          // 动态更新模型信息
          const $maxOutputValue = document.getElementById('maxOutputValue')
          const $cacheWritePriceValue = document.getElementById('cacheWritePriceValue')
          const $cacheReadPriceValue = document.getElementById('cacheReadPriceValue')
          const $outputPriceValue = document.getElementById('outputPriceValue')

          if ($maxOutputValue) $maxOutputValue.textContent = data.maxOutput
          if ($cacheWritePriceValue) $cacheWritePriceValue.textContent = data.cacheWritePrice
          if ($cacheReadPriceValue) $cacheReadPriceValue.textContent = data.cacheReadPrice
          if ($outputPriceValue) $outputPriceValue.textContent = data.outputPrice

          // 更新工具栏中的模型显示
          updateCurrentModelDisplay(model)
        }

        // 自动保存API Key的防抖函数
        let saveTimeout = null
        const autoSaveApiKey = () => {
          clearTimeout(saveTimeout)
          saveTimeout = setTimeout(() => {
            const apiKey = $apiKeyInput.value.trim()
            const model = $modelSelect.value

            // 如果当前显示的是掩码或编辑状态的点号，不进行保存
            if (
              $apiKeyInput.dataset.isMasked === 'true' ||
              $apiKeyInput.dataset.isMasked === 'editing' ||
              apiKey.startsWith('•') || // 检测任何以点号开头的内容
              apiKey.includes('●')
            ) {
              // 检测包含掩码符号的内容
              return
            }

            const validation = validateApiKey(apiKey)

            // 保存有效的API Key 或者 保存空值来删除API Key
            if ((validation.valid && model) || (apiKey === '' && model)) {
              vscode.postMessage({
                type: 'saveConfig',
                payload: { apiKey, model },
                clientId: window.enhancePromptClientId,
              })
            }
          }, 1000) // 1秒后自动保存
        }

        const loadCurrentConfig = () => {
          vscode.postMessage({
            type: 'getConfig',
            clientId: window.enhancePromptClientId,
          })
        }

        // 处理部分编辑的情况 - 保持真实的文本编辑体验
        const handlePartialEdit = () => {
          if ($apiKeyInput.dataset.isPartialEdit === 'true') {
            // 部分编辑状态：保持当前的点号显示，允许继续编辑
            // 不进行任何保存操作，保持编辑状态
            $apiKeyInput.dataset.isMasked = 'editing'
            delete $apiKeyInput.dataset.isPartialEdit

            // 显示提示信息
            const originalPlaceholder = $apiKeyInput.placeholder
            $apiKeyInput.placeholder = 'Continue editing or press Escape to restore...'
            setTimeout(() => {
              $apiKeyInput.placeholder = originalPlaceholder
            }, 3000)
          }
        }

        const validateApiKey = (apiKey) => {
          // 基本格式验证
          if (!apiKey || typeof apiKey !== 'string') {
            return { valid: false, message: '请输入 API Key' }
          }

          const trimmed = apiKey.trim()
          if (trimmed.length < 10) {
            return { valid: false, message: 'API Key 长度过短' }
          }

          if (trimmed.length > 200) {
            return { valid: false, message: 'API Key 长度过长' }
          }

          // 检查是否包含明显的无效字符
          if (!/^[a-zA-Z0-9\-_\.]+$/.test(trimmed)) {
            return { valid: false, message: 'API Key 包含无效字符' }
          }

          return { valid: true, message: '' }
        }

        // ---------- 开发模式特有功能 ----------
        const initDevMode = () => {
          if (!window.isDevelopment) return

          // 开发模式按钮已移除

          // 更新开发信息
          const updateDevInfo = () => {
            if ($devInfo) {
              const state = vscode.getState()
              $devInfo.innerHTML = `
                Client: ${window.enhancePromptClientId.substring(0, 8)}...<br>
                State: ${state ? 'Saved' : 'Empty'}<br>
                Hot Reload: Active
              `
            }
          }

          // 定期更新开发信息
          setInterval(updateDevInfo, 2000)
          updateDevInfo()

          console.log('[DEV] Development mode UI initialized')
        }

        // ---------- 状态水合和初始化 ----------
        const initializeApp = () => {
          if (isInitialized) return

          // 恢复状态
          restoreState()

          // 初始化开发模式
          initDevMode()

          // 初始化配置界面
          loadCurrentConfig()

          // 标记为已初始化
          isInitialized = true
          window.enhancePromptHydrated = true

          // 显示界面（防闪烁）
          $body.classList.add('hydrated')

          // 通知扩展端 WebView 已准备就绪
          vscode.postMessage({
            type: 'ready',
            clientId: window.enhancePromptClientId,
            timestamp: Date.now(),
          })

          const logPrefix = window.isDevelopment ? '[DEV]' : '[EnhancePrompt]'
          console.log(`${logPrefix} App initialized with client ID:`, window.enhancePromptClientId)
        }

        // 等待扩展端初始化完成
        const waitForExtensionReady = () => {
          return new Promise((resolve) => {
            const checkReady = () => {
              if (window.enhancePromptClientId && window.enhancePromptConfig) {
                resolve(true)
              } else {
                setTimeout(checkReady, 10)
              }
            }
            checkReady()
          })
        }

        // ---------- 状态保存和恢复 ----------
        const saveState = () => {
          const state = {
            inputValue: $input.value,
            enhancedText: enhancedText,
            resultVisible: !$result.hidden,
            buttonsEnabled: !$copy.disabled,
            timestamp: Date.now(),
          }
          vscode.setState(state)
        }

        const restoreState = () => {
          const state = vscode.getState()
          if (state) {
            $input.value = state.inputValue || ''
            enhancedText = state.enhancedText || ''
            $result.textContent = enhancedText
            $result.hidden = !state.resultVisible
            $copy.disabled = $clear.disabled = !state.buttonsEnabled

            console.log('[EnhancePrompt] State restored from:', new Date(state.timestamp || 0))
          }
        }

        // ---------- UI 操作辅助函数 ----------
        const toggleBusy = (busy) => {
          $run.disabled = busy
          $run.classList.toggle('loading', busy)

          if (busy) {
            // 处理中状态：只显示文字，不显示图片，避免视觉干扰
            $run.innerHTML = '处理中...'
          } else {
            $run.innerHTML = '<img src="{{SPARKLES_URI}}" alt="sparkles" style="width: 14px; height: 14px;"> 增强'
          }
        }

        const showError = (message) => {
          $result.textContent = `错误: ${message}`
          $result.className = 'result error'
          $result.hidden = false
          $copy.disabled = $clear.disabled = false
        }

        const showSuccess = (content) => {
          enhancedText = content
          $result.textContent = enhancedText
          $result.className = 'result success'
          $result.hidden = false
          $copy.disabled = $clear.disabled = false
          saveState()
        }

        // ---------- 核心操作 ----------
        const runClarify = () => {
          const text = $input.value.trim()
          if (!text) return

          toggleBusy(true)
          vscode.postMessage({
            type: 'clarify',
            payload: text,
            clientId: window.enhancePromptClientId,
          })
        }

        const copyResult = async () => {
          try {
            await navigator.clipboard.writeText(enhancedText)
            // 简单的视觉反馈
            const originalText = $copy.textContent
            $copy.textContent = '已复制'
            setTimeout(() => {
              $copy.textContent = originalText
            }, 1000)
          } catch (error) {
            console.error('复制失败:', error)
          }
        }

        const clearAll = () => {
          $input.value = ''
          $result.textContent = ''
          $result.hidden = true
          $result.className = 'result'
          enhancedText = ''
          $copy.disabled = $clear.disabled = true
          saveState()
        }

        // ---------- 事件绑定 ----------
        $run.addEventListener('click', runClarify)
        $copy.addEventListener('click', copyResult)
        $clear.addEventListener('click', clearAll)

        // 弹出窗口相关事件
        $modelSelector.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          showConfigPopup()
        })

        // 关闭按钮事件
        $popupCloseBtn.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          hideConfigPopup()
        })



        // 阻止弹出窗口内部点击事件冒泡到外层
        $configPopup.addEventListener('click', (e) => {
          e.stopPropagation()
        })

        // 可调整大小手柄事件
        $popupResizeHandle.addEventListener('mousedown', initResize)

        // 弹出窗口内的模型选择事件
        $popupModelSelect.addEventListener('change', (e) => {
          // 阻止事件冒泡
          e.stopPropagation()

          const model = e.target.value
          updatePopupModelInfo(model)
          // 同步到主界面
          $modelSelect.value = model
          selectedModel = model
          updateModelInfo(selectedModel)
          updateCurrentModelDisplay(selectedModel)
          autoSaveApiKey() // 模型变化时也触发自动保存
        })

        // 为弹出窗口中的模型选择器添加焦点事件阻止冒泡
        $popupModelSelect.addEventListener('focus', (e) => {
          e.stopPropagation()
        })

        // 配置相关事件
        $modelSelect.addEventListener('change', (e) => {
          selectedModel = e.target.value
          updateModelInfo(selectedModel)
          updateCurrentModelDisplay(selectedModel)
          // 同步到弹出窗口
          $popupModelSelect.value = selectedModel
          updatePopupModelInfo(selectedModel)
          autoSaveApiKey() // 模型变化时也触发自动保存
        })

        // 弹出窗口中的 API Key 输入处理 - 采用 Cline 的精确交互方案
        $popupApiKeyInput.addEventListener('focus', (e) => {
          // 阻止事件冒泡，防止触发 input-box 的焦点样式
          e.stopPropagation()

          // 当用户点击输入框时，如果当前显示的是掩码，转换为可编辑的点号
          if ($popupApiKeyInput.dataset.isMasked === 'true') {
            // 保存原始掩码，以便恢复
            $popupApiKeyInput.dataset.originalMask = $popupApiKeyInput.value

            // 根据原始掩码长度生成相应长度的点号
            const maskLength = $popupApiKeyInput.value.length
            $popupApiKeyInput.value = '•'.repeat(maskLength) // 保持原有长度
            $popupApiKeyInput.dataset.isMasked = 'editing' // 标记为编辑状态

            // 选中所有内容，方便用户删除或替换
            setTimeout(() => {
              $popupApiKeyInput.select()
            }, 0)
          }
        })

        $popupApiKeyInput.addEventListener('input', (e) => {
          // 阻止事件冒泡
          e.stopPropagation()

          // 用户开始输入时，标记为非掩码状态
          if ($popupApiKeyInput.dataset.isMasked === 'editing') {
            $popupApiKeyInput.dataset.isMasked = 'false'
          }
          // 同步到主界面
          $apiKeyInput.value = $popupApiKeyInput.value
          $apiKeyInput.dataset.isMasked = $popupApiKeyInput.dataset.isMasked
          autoSaveApiKey() // API Key输入时自动保存
        })

        $popupApiKeyInput.addEventListener('blur', () => {
          // 当输入框失去焦点时的处理
          const currentValue = $popupApiKeyInput.value.trim()
          const originalMask = $popupApiKeyInput.dataset.originalMask
          const currentState = $popupApiKeyInput.dataset.isMasked

          if (currentValue === '' && originalMask) {
            // 如果为空且之前有掩码，这意味着用户想要删除API Key
            // 发送删除请求
            vscode.postMessage({
              type: 'saveConfig',
              payload: { apiKey: '', model: $popupModelSelect.value },
              clientId: window.enhancePromptClientId,
            })

            // 保持空状态，不恢复掩码
            $popupApiKeyInput.dataset.isMasked = 'false'
            delete $popupApiKeyInput.dataset.originalMask
            // 同步到主界面
            $apiKeyInput.value = ''
            $apiKeyInput.dataset.isMasked = 'false'
            delete $apiKeyInput.dataset.originalMask
          } else if (currentState === 'editing' && currentValue.startsWith('•') && originalMask) {
            // 如果是未修改的编辑状态（完整的点号），恢复原始掩码
            const originalLength = originalMask.length
            if (currentValue === '•'.repeat(originalLength)) {
              $popupApiKeyInput.value = originalMask
              $popupApiKeyInput.dataset.isMasked = 'true'
              delete $popupApiKeyInput.dataset.originalMask
              // 同步到主界面
              $apiKeyInput.value = originalMask
              $apiKeyInput.dataset.isMasked = 'true'
              delete $apiKeyInput.dataset.originalMask
            } else {
              // 部分编辑的点号，这意味着用户删除了部分内容，应该删除API Key
              vscode.postMessage({
                type: 'saveConfig',
                payload: { apiKey: '', model: $popupModelSelect.value },
                clientId: window.enhancePromptClientId,
              })

              // 清空输入框
              $popupApiKeyInput.value = ''
              $popupApiKeyInput.dataset.isMasked = 'false'
              delete $popupApiKeyInput.dataset.originalMask
              // 同步到主界面
              $apiKeyInput.value = ''
              $apiKeyInput.dataset.isMasked = 'false'
              delete $apiKeyInput.dataset.originalMask
            }
          } else if (currentValue !== '' && !currentValue.startsWith('•')) {
            // 如果有新的输入（不是点号），保持当前状态
            $popupApiKeyInput.dataset.isMasked = 'false'
            delete $popupApiKeyInput.dataset.originalMask
            // 同步到主界面
            $apiKeyInput.value = $popupApiKeyInput.value
            $apiKeyInput.dataset.isMasked = 'false'
            delete $apiKeyInput.dataset.originalMask
          }
        })

        // 弹出窗口中的键盘处理
        $popupApiKeyInput.addEventListener('keydown', (e) => {
          // 如果在编辑状态下按下任何字符键，清空点号开始输入
          if (
            $popupApiKeyInput.dataset.isMasked === 'editing' &&
            e.key.length === 1 &&
            !e.ctrlKey &&
            !e.metaKey &&
            !e.altKey
          ) {
            // 不阻止默认行为，让字符正常输入
            $popupApiKeyInput.value = ''
            $popupApiKeyInput.dataset.isMasked = 'false'
            // 字符会在 keydown 后自动输入
          }
        })

        // API Key 输入处理 - 采用 Cline 的精确交互方案
        $apiKeyInput.addEventListener('focus', () => {
          // 当用户点击输入框时，如果当前显示的是掩码，转换为可编辑的点号
          if ($apiKeyInput.dataset.isMasked === 'true') {
            // 保存原始掩码，以便恢复
            $apiKeyInput.dataset.originalMask = $apiKeyInput.value

            // 根据原始掩码长度生成相应长度的点号
            const maskLength = $apiKeyInput.value.length
            $apiKeyInput.value = '•'.repeat(maskLength) // 保持原有长度
            $apiKeyInput.dataset.isMasked = 'editing' // 标记为编辑状态

            // 选中所有内容，方便用户删除或替换
            setTimeout(() => {
              $apiKeyInput.select()
            }, 0)
          }
        })

        $apiKeyInput.addEventListener('input', () => {
          // 用户开始输入时，标记为非掩码状态
          if ($apiKeyInput.dataset.isMasked === 'editing') {
            $apiKeyInput.dataset.isMasked = 'false'
          }
          autoSaveApiKey() // API Key输入时自动保存
        })

        $apiKeyInput.addEventListener('blur', () => {
          // 当输入框失去焦点时的处理
          const currentValue = $apiKeyInput.value.trim()
          const originalMask = $apiKeyInput.dataset.originalMask
          const currentState = $apiKeyInput.dataset.isMasked

          if (currentValue === '' && originalMask) {
            // 如果为空且之前有掩码，这意味着用户想要删除API Key
            // 发送删除请求
            vscode.postMessage({
              type: 'saveConfig',
              payload: { apiKey: '', model: $modelSelect.value },
              clientId: window.enhancePromptClientId,
            })

            // 保持空状态，不恢复掩码
            $apiKeyInput.dataset.isMasked = 'false'
            delete $apiKeyInput.dataset.originalMask
          } else if (currentState === 'editing' && currentValue.startsWith('•') && originalMask) {
            // 如果是未修改的编辑状态（完整的点号），恢复原始掩码
            const originalLength = originalMask.length
            if (currentValue === '•'.repeat(originalLength)) {
              $apiKeyInput.value = originalMask
              $apiKeyInput.dataset.isMasked = 'true'
              delete $apiKeyInput.dataset.originalMask
            } else {
              // 部分编辑的点号，这意味着用户删除了部分内容，应该删除API Key
              vscode.postMessage({
                type: 'saveConfig',
                payload: { apiKey: '', model: $modelSelect.value },
                clientId: window.enhancePromptClientId,
              })

              // 清空输入框
              $apiKeyInput.value = ''
              $apiKeyInput.dataset.isMasked = 'false'
              delete $apiKeyInput.dataset.originalMask
            }
          } else if (currentState === 'modified' && currentValue.startsWith('•')) {
            // 修改后的点号状态，这也意味着用户想要删除API Key
            vscode.postMessage({
              type: 'saveConfig',
              payload: { apiKey: '', model: $modelSelect.value },
              clientId: window.enhancePromptClientId,
            })

            // 清空输入框
            $apiKeyInput.value = ''
            $apiKeyInput.dataset.isMasked = 'false'
            delete $apiKeyInput.dataset.originalMask
          } else if (currentValue !== '' && !currentValue.startsWith('•')) {
            // 如果有新的输入（不是点号），保持当前状态
            $apiKeyInput.dataset.isMasked = 'false'
            delete $apiKeyInput.dataset.originalMask
          }

          // 处理部分编辑的情况
          setTimeout(() => {
            handlePartialEdit()
          }, 100) // 短暂延迟确保状态更新完成
        })

        // 处理键盘事件，提供更好的编辑体验
        $apiKeyInput.addEventListener('keydown', (e) => {
          // 如果在编辑状态下按下任何字符键，清空点号开始输入
          if (
            $apiKeyInput.dataset.isMasked === 'editing' &&
            e.key.length === 1 &&
            !e.ctrlKey &&
            !e.metaKey &&
            !e.altKey
          ) {
            // 不阻止默认行为，让字符正常输入
            $apiKeyInput.value = ''
            $apiKeyInput.dataset.isMasked = 'false'
            // 字符会在 keydown 后自动输入
          }

          // 精细的删除操作处理
          if ($apiKeyInput.dataset.isMasked === 'editing' && (e.key === 'Delete' || e.key === 'Backspace')) {
            e.preventDefault() // 阻止默认行为

            const currentValue = $apiKeyInput.value
            const selectionStart = $apiKeyInput.selectionStart
            const selectionEnd = $apiKeyInput.selectionEnd
            const hasSelection = selectionStart !== selectionEnd

            if (hasSelection) {
              // 有选中文本：删除选中的部分
              const beforeSelection = currentValue.substring(0, selectionStart)
              const afterSelection = currentValue.substring(selectionEnd)
              $apiKeyInput.value = beforeSelection + afterSelection
              $apiKeyInput.setSelectionRange(selectionStart, selectionStart)

              // 如果删除后为空，切换到输入模式
              if ($apiKeyInput.value === '') {
                $apiKeyInput.dataset.isMasked = 'false'
              } else {
                // 保持编辑状态，但标记为已修改
                $apiKeyInput.dataset.isMasked = 'modified'
              }
            } else {
              // 无选中文本：逐个删除
              if (e.key === 'Backspace' && selectionStart > 0) {
                // Backspace：删除光标前的一个字符
                const beforeCursor = currentValue.substring(0, selectionStart - 1)
                const afterCursor = currentValue.substring(selectionStart)
                $apiKeyInput.value = beforeCursor + afterCursor
                $apiKeyInput.setSelectionRange(selectionStart - 1, selectionStart - 1)
              } else if (e.key === 'Delete' && selectionStart < currentValue.length) {
                // Delete：删除光标后的一个字符
                const beforeCursor = currentValue.substring(0, selectionStart)
                const afterCursor = currentValue.substring(selectionStart + 1)
                $apiKeyInput.value = beforeCursor + afterCursor
                $apiKeyInput.setSelectionRange(selectionStart, selectionStart)
              }

              // 如果删除后为空，切换到输入模式
              if ($apiKeyInput.value === '') {
                $apiKeyInput.dataset.isMasked = 'false'
              } else {
                // 保持编辑状态，但标记为已修改
                $apiKeyInput.dataset.isMasked = 'modified'
              }
            }
          }

          // 如果按下 Escape，恢复原始掩码
          if ($apiKeyInput.dataset.isMasked === 'editing' && e.key === 'Escape') {
            const originalMask = $apiKeyInput.dataset.originalMask
            if (originalMask) {
              $apiKeyInput.value = originalMask
              $apiKeyInput.dataset.isMasked = 'true'
              delete $apiKeyInput.dataset.originalMask
              $apiKeyInput.blur() // 失去焦点
            }
          }

          // 如果按下 Enter，确认当前的编辑并删除 API Key
          if ($apiKeyInput.dataset.isMasked === 'editing' && e.key === 'Enter') {
            const currentValue = $apiKeyInput.value
            if (
              currentValue.startsWith('•') &&
              currentValue.length < ($apiKeyInput.dataset.originalMask?.length || 0)
            ) {
              // 部分删除，确认删除 API Key
              vscode.postMessage({
                type: 'saveConfig',
                payload: { apiKey: '', model: $modelSelect.value },
                clientId: window.enhancePromptClientId,
              })

              // 清空输入框
              $apiKeyInput.value = ''
              $apiKeyInput.dataset.isMasked = 'false'
              delete $apiKeyInput.dataset.originalMask
              $apiKeyInput.blur()
            }
          }
        })

        $input.addEventListener('keydown', (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
            e.preventDefault()
            runClarify()
          }
        })

        // 监听输入变化，保存状态
        $input.addEventListener('input', saveState)

        // 监听来自扩展的消息
        window.addEventListener('message', (e) => {
          const { type, payload, error, config, success } = e.data

          switch (type) {
            case 'result':
              toggleBusy(false)
              if (error) {
                showError(error)
              } else {
                showSuccess(payload)
              }
              break

            case 'configData':
              if (error) {
                console.error('Failed to load config:', error)
              } else {
                currentConfig = payload
                if (payload.hasApiKey && payload.apiKeyMasked) {
                  // 显示掩码版本的API Key，采用Cline的方案
                  $apiKeyInput.value = payload.apiKeyMasked
                  $apiKeyInput.placeholder = 'Enter API Key...'
                  $apiKeyInput.dataset.isMasked = 'true'

                  // 同步到弹出窗口
                  $popupApiKeyInput.value = payload.apiKeyMasked
                  $popupApiKeyInput.placeholder = 'Enter API Key...'
                  $popupApiKeyInput.dataset.isMasked = 'true'
                } else {
                  // 没有API Key时显示空值
                  $apiKeyInput.value = ''
                  $apiKeyInput.placeholder = 'Enter API Key...'
                  $apiKeyInput.dataset.isMasked = 'false'

                  // 同步到弹出窗口
                  $popupApiKeyInput.value = ''
                  $popupApiKeyInput.placeholder = 'Enter API Key...'
                  $popupApiKeyInput.dataset.isMasked = 'false'
                }
                if (payload.model) {
                  $modelSelect.value = payload.model
                  selectedModel = payload.model
                  updateModelInfo(selectedModel)
                  updateCurrentModelDisplay(selectedModel)

                  // 同步到弹出窗口
                  $popupModelSelect.value = payload.model
                  updatePopupModelInfo(payload.model)
                } else {
                  // 如果没有保存的模型，默认选择deepseek-chat
                  $modelSelect.value = 'deepseek-chat'
                  selectedModel = 'deepseek-chat'
                  updateModelInfo(selectedModel)
                  updateCurrentModelDisplay(selectedModel)

                  // 同步到弹出窗口
                  $popupModelSelect.value = 'deepseek-chat'
                  updatePopupModelInfo('deepseek-chat')
                }
              }
              break

            case 'configSaved':
              if (success) {
                console.log('配置保存成功')

                // 只有在当前不是编辑状态时才重新加载配置
                // 这样可以避免用户删除掩码后又重新出现的问题
                if ($apiKeyInput.dataset.isMasked !== 'editing' && $apiKeyInput.dataset.isMasked !== 'false') {
                  loadCurrentConfig() // 重新加载配置状态
                }

                // 保存成功后，显示简短的成功反馈
                const originalPlaceholder = $apiKeyInput.placeholder
                $apiKeyInput.placeholder = 'API Key saved successfully!'
                setTimeout(() => {
                  $apiKeyInput.placeholder = originalPlaceholder
                }, 2000)
              } else {
                console.error(`保存失败: ${error || '未知错误'}`)

                // 保存失败时显示错误反馈
                const originalPlaceholder = $apiKeyInput.placeholder
                $apiKeyInput.placeholder = `Save failed: ${error || 'Unknown error'}`
                setTimeout(() => {
                  $apiKeyInput.placeholder = originalPlaceholder
                }, 3000)
              }
              break

            case 'init':
              // 扩展端初始化完成，更新配置
              if (config) {
                window.enhancePromptConfig = { ...window.enhancePromptConfig, ...config }
                console.log('[EnhancePrompt] Received init config:', config)
              }
              break

            default:
              console.log('[EnhancePrompt] Unknown message type:', type)
          }
        })

        // ---------- 应用启动 ----------
        // 等待配置就绪后初始化应用
        waitForExtensionReady().then(() => {
          // 使用 requestAnimationFrame 确保 DOM 完全准备好
          requestAnimationFrame(() => {
            initializeApp()
          })
        })

        // 页面可见性变化时重新初始化（处理 WebView 隐藏/显示）
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden && window.enhancePromptHydrated) {
            console.log('[EnhancePrompt] WebView became visible, ensuring state consistency')
            restoreState()
          }
        })
      })()
    </script>
  </body>
</html>
