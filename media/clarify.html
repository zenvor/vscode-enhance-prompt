<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none';
               img-src vscode-resource:;
               style-src 'unsafe-inline' vscode-resource:;
               script-src 'unsafe-inline' vscode-resource:;"
    />
    <title>Enhance Prompt — Clarify</title>

    <style>
      :root {
        --radius: 2px;
        --padding: 10px;
      }

      /* 重置默认样式 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        width: 100%;
        height: 100%;
        background-color: var(--vscode-sideBar-background);
        padding: var(--padding);
      }

      body {
        font-family: var(--vscode-font-family);
        color: var(--vscode-editor-foreground);
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: var(--padding);
      }

      /* 输入区 ---------------------------------------------------------------- */
      .input-box {
        border: 1px solid var(--vscode-input-border, var(--vscode-editorWidget-border));
        border-radius: var(--radius);
        background: var(--vscode-input-background);
        display: flex;
        flex-direction: column;
        transition: border-color 0.15s;
      }

      .input-box:focus-within {
        border-color: var(--vscode-focusBorder, #007acc);
      }

      textarea {
        resize: none;
        min-height: 100px;
        max-height: 300px;
        border: none;
        outline: none;
        padding: 8px;
        background: transparent;
        color: var(--vscode-input-foreground);
        font-family: var(--vscode-editor-font-family, var(--vscode-font-family));
        line-height: 1.4;
        box-shadow: none;
        /* 隐藏滚动条 */
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }

      textarea::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      textarea::placeholder {
        color: var(--vscode-input-placeholderForeground);
      }

      textarea:focus {
        outline: none;
        box-shadow: none;
      }

      /* 工具栏 ---------------------------------------------------------------- */
      .toolbar {
        display: flex;
        justify-content: flex-end;
        gap: 6px;
        padding: 6px 8px;
        border-top: 1px solid var(--vscode-editorWidget-border);
      }

      .btn {
        border: none;
        cursor: pointer;
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        padding: 2px 10px;
        border-radius: var(--radius);
        font-size: 12px;
        line-height: 20px;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: background 0.15s;
      }

      .btn:hover:not(:disabled) {
        background: var(--vscode-button-hoverBackground, #005f9e);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--vscode-button-background); /* 避免 hover 变色 */
      }

      .btn img {
        vertical-align: middle;
        filter: brightness(0) invert(1); /* Make SVG white to match button text */
      }

      /* 结果区 ---------------------------------------------------------------- */
      .result {
        border: 1px solid var(--vscode-editorWidget-border);
        border-radius: var(--radius);
        background: var(--vscode-editorWidget-background);
        padding: 8px;
        white-space: pre-wrap;
        overflow-y: auto;
        max-height: 400px;
        font-family: var(--vscode-editor-font-family, var(--vscode-font-family));
        /* 隐藏滚动条 */
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }

      .result::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }


    </style>
  </head>

  <body>
    <!-- 输入框 -->
    <div class="input-box">
      <textarea id="input" placeholder="输入原始描述… ( Ctrl/Cmd + Enter 执行 )"></textarea>
      <div class="toolbar">
        <button id="runBtn" class="btn">
          <img src="media/sparkles-outline.svg" alt="sparkles" style="width: 14px; height: 14px" /> 增强
        </button>
        <button id="copyBtn" class="btn" disabled>复制</button>
        <button id="clearBtn" class="btn" disabled>清空</button>
      </div>
    </div>

    <!-- 结果展示 -->
    <pre id="result" class="result" hidden></pre>

    <script>
      ;(() => {
        const vscode = acquireVsCodeApi()
        const $input = document.getElementById('input')
        const $run = document.getElementById('runBtn')
        const $copy = document.getElementById('copyBtn')
        const $clear = document.getElementById('clearBtn')

        const $result = document.getElementById('result')

        let enhancedText = ''

        // ---------- 状态保存和恢复 ----------
        const saveState = () => {
          const state = {
            inputValue: $input.value,
            enhancedText: enhancedText,
            resultVisible: !$result.hidden,
            buttonsEnabled: !$copy.disabled,
          }
          vscode.setState(state)
        }

        const restoreState = () => {
          const state = vscode.getState()
          if (state) {
            $input.value = state.inputValue || ''
            enhancedText = state.enhancedText || ''
            $result.textContent = enhancedText
            $result.hidden = !state.resultVisible
            $copy.disabled = $clear.disabled = !state.buttonsEnabled
          }
        }

        // 页面加载时恢复状态
        restoreState()

        // ---------- helpers ----------
        const toggleBusy = (busy) => {
          $run.disabled = busy
          if (busy) {
            $run.innerHTML =
              '<img src="media/sparkles-outline.svg" alt="loading" style="width: 14px; height: 14px;"> 增强'
          } else {
            $run.innerHTML =
              '<img src="media/sparkles-outline.svg" alt="sparkles" style="width: 14px; height: 14px;"> 增强'
          }
        }

        // ---------- actions ----------
        const runClarify = () => {
          const text = $input.value.trim()
          if (!text) return // 输入为空或仅空格时直接返回，不弹任何提示
          toggleBusy(true)
          vscode.postMessage({ type: 'clarify', payload: text })
        }

        const copyResult = () => {
          navigator.clipboard.writeText(enhancedText)
        }

        const clearAll = () => {
          $input.value = ''
          $result.textContent = ''
          $result.hidden = true
          enhancedText = ''
          $copy.disabled = $clear.disabled = true
          saveState()
        }

        // ---------- event bindings ----------
        $run.addEventListener('click', runClarify)
        $copy.addEventListener('click', copyResult)
        $clear.addEventListener('click', clearAll)

        $input.addEventListener('keydown', (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
            e.preventDefault()
            runClarify()
          }
        })

        window.addEventListener('message', (e) => {
          if (e.data.type !== 'result') return
          toggleBusy(false)
          enhancedText = e.data.payload
          $result.textContent = enhancedText
          $result.hidden = false
          $copy.disabled = $clear.disabled = false
          saveState()
        })

        // 监听输入变化，保存状态
        $input.addEventListener('input', saveState)
      })()
    </script>
  </body>
</html>
